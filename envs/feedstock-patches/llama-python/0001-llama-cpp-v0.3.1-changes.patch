From 5fddb63c031e63680972f4c89d0ca97fcb4f9d96 Mon Sep 17 00:00:00 2001
From: Archana-Shinde1 <Archana.Shinde1@ibm.com>
Date: Thu, 3 Oct 2024 12:25:18 +0000
Subject: [PATCH] fixed import and opence changes

---
 recipe/0001-try-library-in-path.patch | 43 +++++++++++++++++++++++++++
 recipe/meta.yaml                      | 26 ++++++++--------
 2 files changed, 56 insertions(+), 13 deletions(-)
 create mode 100644 recipe/0001-try-library-in-path.patch

diff --git a/recipe/0001-try-library-in-path.patch b/recipe/0001-try-library-in-path.patch
new file mode 100644
index 0000000..edcf1c7
--- /dev/null
+++ b/recipe/0001-try-library-in-path.patch
@@ -0,0 +1,43 @@
+From 34f7480c3838c266d07bf48086880b5791d0c082 Mon Sep 17 00:00:00 2001
+From: Archana-Shinde1 <Archana.Shinde1@ibm.com>
+Date: Thu, 3 Oct 2024 12:06:06 +0000
+Subject: [PATCH] try library in path
+
+---
+ llama_cpp/_ctypes_extensions.py | 7 +++++--
+ 1 file changed, 5 insertions(+), 2 deletions(-)
+
+diff --git a/llama_cpp/_ctypes_extensions.py b/llama_cpp/_ctypes_extensions.py
+index e88ed38..15562bc 100644
+--- a/llama_cpp/_ctypes_extensions.py
++++ b/llama_cpp/_ctypes_extensions.py
+@@ -29,6 +29,7 @@ def load_shared_library(lib_base_name: str, base_path: pathlib.Path):
+     if sys.platform.startswith("linux") or sys.platform.startswith("freebsd"):
+         lib_paths += [
+             base_path / f"lib{lib_base_name}.so",
++            f"lib{lib_base_name}.so",
+         ]
+     elif sys.platform == "darwin":
+         lib_paths += [
+@@ -62,14 +63,16 @@ def load_shared_library(lib_base_name: str, base_path: pathlib.Path):
+ 
+     # Try to load the shared library, handling potential errors
+     for lib_path in lib_paths:
+-        if lib_path.exists():
++        if isinstance(lib_path, str) or lib_path.exists():
+             try:
+                 return ctypes.CDLL(str(lib_path), **cdll_args)  # type: ignore
++            except OSError:
++                pass
+             except Exception as e:
+                 raise RuntimeError(f"Failed to load shared library '{lib_path}': {e}")
+ 
+     raise FileNotFoundError(
+-        f"Shared library with base name '{lib_base_name}' not found"
++        f"Shared library with base name '{lib_base_name}' not found in {lib_paths}"
+     )
+ 
+ 
+-- 
+2.40.1
+
diff --git a/recipe/meta.yaml b/recipe/meta.yaml
index 9389001..bc80b9b 100644
--- a/recipe/meta.yaml
+++ b/recipe/meta.yaml
@@ -1,7 +1,7 @@
 {% set name = "llama-cpp-python" %}
 # NOTE: VERIFY llama_cpp_version before merging!
-{% set version = "0.2.24" %}
-{% set llama_cpp_version = "0.0.1660" %}
+{% set version = "0.3.1" %}
+{% set llama_cpp_version = "0.0.3821" %}
 
 package:
   name: {{ name|lower }}
@@ -9,10 +9,9 @@ package:
 
 source:
   url: https://pypi.io/packages/source/{{ name[0] }}/{{ name }}/llama_cpp_python-{{ version }}.tar.gz
-  sha256: 85f8fd110b4b90599d5ff427bd4a1a4db6e70817c60ba8aa609fa5c645761ec1
+  sha256: 75ec8374960b6353c254e55a48e7c7783abf6bcb9178ba0f655490738e5a9004 #v0.3.1
   patches:
-    # Asks cdll to look for the library in the path as well.
-    - try-lib-in-path.patch
+    - 0001-try-library-in-path.patch
 
 build:
   number: 0
@@ -28,24 +27,24 @@ build:
     - {{ PYTHON }} -m pip install . -vv
 requirements:
   build:
-    - python                                 # [build_platform != target_platform]
+    - python {{ python }}                            # [build_platform != target_platform]
     - cross-python_{{ target_platform }}     # [build_platform != target_platform]
 
-    - {{ compiler('c') }}
-    - {{ compiler('cxx') }}
+    - {{ compiler('c') }}      # [ ppc_arch != "p10"]
+    - {{ compiler('cxx') }}    # [ ppc_arch != "p10"]
     - cmake
     - make
-    - pkgconfig
+    - pkg-config {{ pkgconfig }}
 
   host:
-    - python
+    - python {{ python }}
     - scikit-build-core >=0.5.1
-    - pip
+    - pip {{ pip }}
 
   run:
-    - python
+    - python {{ python }}
     - typing-extensions >=4.5.0
-    - numpy >=1.20.0
+    - numpy {{ numpy }}
     - diskcache >=5.6.1
 
     - llama.cpp {{ llama_cpp_version }}
@@ -63,6 +62,7 @@ test:
     - pip check
   requires:
     - pip
+    - jinja2
 
 about:
   home: https://github.com/abetlen/llama-cpp-python
-- 
2.40.1

