From 3900b833331944bdd530066ecaa1edb42e43cad8 Mon Sep 17 00:00:00 2001
From: Nishidha Panpaliya <npanpa23@in.ibm.com>
Date: Mon, 31 Jan 2022 00:11:51 -0600
Subject: [PATCH] Fix clang build for p10

---
 recipe/build.sh  | 11 +++++++++++
 recipe/meta.yaml | 20 ++++++++++----------
 2 files changed, 21 insertions(+), 10 deletions(-)

diff --git a/recipe/build.sh b/recipe/build.sh
index 0df298f..ee68108 100644
--- a/recipe/build.sh
+++ b/recipe/build.sh
@@ -13,6 +13,17 @@ if [[ "$variant" == "hcc" ]]; then
   EXTRA_ARGS="$EXTRA_ARGS -DKALMAR_SDK_COMMIT=24e69cd8 -DKALMAR_FRONTEND_COMMIT=24e69cd8 -DKALMAR_BACKEND_COMMIT=24e69cd8"
 fi
 
+if [[ $ppc_arch == "p10" ]]
+then
+    if [[ -z "${GCC_10_HOME}" ]];
+    then
+        echo "Please set GCC_10_HOME to the install path of gcc-toolset-10"
+        exit 1
+    else
+        AR=$GCC_10_HOME/bin/ar
+    fi
+fi
+
 cmake \
   -DCMAKE_INSTALL_PREFIX=$PREFIX \
   -DCMAKE_PREFIX_PATH=$PREFIX \
diff --git a/recipe/meta.yaml b/recipe/meta.yaml
index 946e808..e71a150 100644
--- a/recipe/meta.yaml
+++ b/recipe/meta.yaml
@@ -28,7 +28,7 @@ build:
 
 requirements:
   build:
-    - {{ compiler('cxx') }}
+    - {{ compiler('cxx') }}    # [ ppc_arch != "p10"]
     - cmake >=3.4.3
     # Needed to unpack the source tarball
     - m2w64-xz  # [win]
@@ -43,7 +43,7 @@ requirements:
 
 test:
   requires:
-    - {{ compiler('cxx') }}
+    - {{ compiler('cxx') }}      # [ ppc_arch != "p10"]
     - cmake >=3.4.3
   files:
     - mytest.c
@@ -70,7 +70,7 @@ outputs:
       string: {{ variant }}_h{{ PKG_HASH }}_{{ build_number }}
     requirements:
       build:
-        - {{ compiler('cxx') }}
+        - {{ compiler('cxx') }}    # [ ppc_arch != "p10"]
         - cmake >=3.4.3
         - ninja  # [win]
         - make   # [unix]
@@ -108,7 +108,7 @@ outputs:
       skip: true  # [win]
     requirements:
       build:
-        - {{ compiler('cxx') }}
+        - {{ compiler('cxx') }}    # [ ppc_arch != "p10"]
         - cmake >=3.4.3
         - ninja  # [win]
         - make   # [unix]
@@ -137,7 +137,7 @@ outputs:
       {% endif %}
     requirements:
       build:
-        - {{ compiler('cxx') }}
+        - {{ compiler('cxx') }}     # [ ppc_arch != "p10"]
         - cmake >=3.4.3
         - ninja  # [win]
         - make   # [unix]
@@ -164,7 +164,7 @@ outputs:
       string: {{ variant }}_h{{ PKG_HASH }}_{{ build_number }}
     requirements:
       build:
-        - {{ compiler('cxx') }}
+        - {{ compiler('cxx') }}    # [ ppc_arch != "p10"]
         - cmake >=3.4.3
         - ninja  # [win]
         - make   # [unix]
@@ -191,7 +191,7 @@ outputs:
       string: {{ variant }}_h{{ PKG_HASH }}_{{ build_number }}
     requirements:
       build:
-        - {{ compiler('cxx') }}
+        - {{ compiler('cxx') }}    # [ ppc_arch != "p10"]
         - libcxx                   # [osx]
         - cmake >=3.4.3
         - ninja  # [win]
@@ -235,8 +235,8 @@ outputs:
       run:
         - {{ pin_subpackage("clang", exact=True) }}
     test:
-      requires:
-        - {{ compiler("cxx") }}
+      requires:                    # [ ppc_arch != "p10"]
+        - {{ compiler("cxx") }}    # [ ppc_arch != "p10"]
       files:
         - mytest.cxx
       commands:
@@ -254,7 +254,7 @@ outputs:
       build:
         # "compiling .pyc files" fails without this
         - python >3
-        - {{ compiler('cxx') }}
+        - {{ compiler('cxx') }}     # [ ppc_arch != "p10"]
         - cmake >=3.4.3
         - ninja  # [win]
         - make   # [unix]
-- 
2.34.1

