From 4ba3d80b7cc85329d8d83a731509de0f7699c57a Mon Sep 17 00:00:00 2001
From: Aman Surkar <Aman.Surkar@ibm.com>
Date: Fri, 4 Oct 2024 04:50:54 +0000
Subject: [PATCH] opence changes

---
 recipe/build.sh  |  8 +++++++-
 recipe/meta.yaml | 26 ++++++++++++++------------
 2 files changed, 21 insertions(+), 13 deletions(-)

diff --git a/recipe/build.sh b/recipe/build.sh
index 67d4b81..d1e29ee 100755
--- a/recipe/build.sh
+++ b/recipe/build.sh
@@ -3,7 +3,7 @@
 set -ex
 
 case "${target_platform}" in
-  linux-aarch64|osx-arm64)
+  linux-aarch64|osx-arm64|linux-ppc64le)
     arch="aarch64"
     ;;
   *)
@@ -11,6 +11,12 @@ case "${target_platform}" in
     ;;
 esac
 
+if [[ "$target_platform" == "linux-ppc64le" ]]; then
+  CFLAGS="$(echo $CFLAGS | sed 's/-fno-plt //g')"
+  CXXFLAGS="$(echo $CXXFLAGS | sed 's/-fno-plt //g')"
+  LDFLAGS="$(echo $LDFLAGS | sed 's/-fno-plt //g')"
+fi
+
 cpu_check_module="py-polars/polars/_cpu_check.py"
 features=""
 
diff --git a/recipe/meta.yaml b/recipe/meta.yaml
index 221b6e5..54aeb2f 100644
--- a/recipe/meta.yaml
+++ b/recipe/meta.yaml
@@ -1,9 +1,10 @@
+{% set name = "polars" %}
 {% set version = "1.7.1" %}
 
 # Note: This recipe is specifically designed to work well with the autotick bot.
 # Also refer to https://github.com/conda-forge/rust-feedstock/blob/main/recipe/meta.yaml.
 package:
-  name: {{ polars_variant }}
+  name: {{ name }}
   version: {{ version }}
 
 source:
@@ -12,8 +13,7 @@ source:
   - url: https://pypi.io/packages/source/p/polars-lts-cpu/polars_lts_cpu-{{ version }}.tar.gz  # [polars_variant == "polars-lts-cpu"]
     sha256: 27ec71a2c7cf367e2d8d1b1a6c9694600ca3a5e06fe11a18c434e2ba40073999  # [polars_variant == "polars-lts-cpu"]
   - url: https://pypi.io/packages/source/p/polars-u64-idx/polars_u64_idx-{{ version }}.tar.gz  # [polars_variant == "polars-u64-idx"]
-    sha256: c95960576997f2f230e04085de96719381b453217d61bd76ee4219743353d00e  # [polars_variant == "polars-u64-idx"]
-
+    sha256: c95960576997f2f230e04085de96719381b453217d61bd76ee4219743353d00e  # [polars_variant == "polars-u64-idx"]  
 
 build:
   number: 0
@@ -22,7 +22,7 @@ build:
 
 requirements:
   build:
-    - python                              # [build_platform != target_platform]
+    - python {{python}}                             # [build_platform != target_platform]
     # there is no cross-python for linux-64 -> win-64
     - cross-python_{{ target_platform }}  # [build_platform != target_platform and not target_platform == "win-64"]
     - crossenv                            # [build_platform != target_platform]
@@ -30,22 +30,24 @@ requirements:
     - {{ compiler('c') }}
     - {{ compiler('cxx') }}               # [win]
     # clang_win-64 already adds all required run_exports for the windows build
-    - {{ stdlib("c") }}  # [not (build_platform == "linux-64" and target_platform == "win-64")]
+    - sysroot_{{ target_platform }} 2.17 # [linux]  # [not (build_platform == "linux-64" and target_platform == "win-64")]
     - {{ compiler('rust') }}
     - posix                               # [build_platform == "win-64"]
-    - cmake
-    - make                                # [unix]
+    - cmake {{cmake}}
+    - make {{make}}                               # [unix]
     - cargo-feature                       # [build_platform != target_platform and target_platform == "win-64"]
     - cargo-bundle-licenses
+    - rust-nightly {{rust_nightly}}
   host:
-    - python
-    - pip
+    - python {{python}}
+    - pip {{pip}}
     - maturin >=1.3.2,<2
+    - rust-nightly {{rust_nightly}}
   run:
-    - python
-    - numpy >=1.16.0
+    - python {{python}}
+    - numpy {{numpy}}
     - backports.zoneinfo                   # [py<39]
-    - typing_extensions >=4.0.0            # [py<311]
+    - typing_extensions {{typing_extensions}}            # [py<311]
     - packaging                            # [py>=310]
 
 test:
-- 
2.40.1

