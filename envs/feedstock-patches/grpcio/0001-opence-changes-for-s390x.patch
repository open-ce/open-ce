From 73124a58b197dd0365310143362d6fe494bc18ee Mon Sep 17 00:00:00 2001
From: ArchanaShinde1 <archana.shinde2504@gmail.com>
Date: Tue, 20 Feb 2024 11:56:18 +0000
Subject: [PATCH] Update to 1.53.2 to fix CVE

---
 config/conda_build_config.yaml          |  4 ++++
 recipe/0001-Fix-openssl-for-s390x.patch | 25 +++++++++++++++++++
 recipe/build.sh                         | 19 +++++++++++----
 recipe/meta.yaml                        | 32 ++++++++++++-------------
 4 files changed, 60 insertions(+), 20 deletions(-)
 create mode 100644 config/conda_build_config.yaml
 create mode 100644 recipe/0001-Fix-openssl-for-s390x.patch

diff --git a/config/conda_build_config.yaml b/config/conda_build_config.yaml
new file mode 100644
index 0000000..521aa13
--- /dev/null
+++ b/config/conda_build_config.yaml
@@ -0,0 +1,4 @@
+c_compiler_version:
+  - 11.2.0          # [cudatoolkit == "11.2"]
+cxx_compiler_version:
+  - 11.2.0          # [cudatoolkit == "11.2"]
diff --git a/recipe/0001-Fix-openssl-for-s390x.patch b/recipe/0001-Fix-openssl-for-s390x.patch
new file mode 100644
index 0000000..db2134d
--- /dev/null
+++ b/recipe/0001-Fix-openssl-for-s390x.patch
@@ -0,0 +1,25 @@
+From c9e4eb6376241855411f927f59109754e4404aa5 Mon Sep 17 00:00:00 2001
+From: Deepali Chourasia <deepch23@in.ibm.com>
+Date: Wed, 16 Aug 2023 07:34:18 +0000
+Subject: [PATCH] Fix openssl for s390x
+
+---
+ src/include/openssl/base.h | 2 +-
+ 1 file changed, 1 insertion(+), 1 deletion(-)
+
+diff --git a/src/include/openssl/base.h b/src/include/openssl/base.h
+index a1a4309a4..8db692ea3 100644
+--- a/src/include/openssl/base.h
++++ b/src/include/openssl/base.h
+@@ -121,7 +121,7 @@ extern "C" {
+ // little-endian architectures. Functions will not produce the correct answer
+ // on other systems. Run the crypto_test binary, notably
+ // crypto/compiler_test.cc, before adding a new architecture.
+-#error "Unknown target CPU"
++#define OPENSSL_64_BIT
+ #endif
+ 
+ #if defined(__APPLE__)
+-- 
+2.40.1
+
diff --git a/recipe/build.sh b/recipe/build.sh
index f797569..ca7c25a 100644
--- a/recipe/build.sh
+++ b/recipe/build.sh
@@ -1,12 +1,23 @@
 #!/bin/bash
 
+set -ex
+
 export GRPC_BUILD_WITH_BORING_SSL_ASM=""
-export GRPC_PYTHON_BUILD_SYSTEM_ZLIB="True"
-export GRPC_PYTHON_BUILD_SYSTEM_OPENSSL="True"
-export GRPC_PYTHON_BUILD_SYSTEM_CARES="True"
+export GRPC_PYTHON_BUILD_SYSTEM_ZLIB="False"
+export GRPC_PYTHON_BUILD_SYSTEM_OPENSSL="False"
+export GRPC_PYTHON_BUILD_SYSTEM_CARES="False"
 export GRPC_PYTHON_USE_PREBUILT_GRPC_CORE=""
 export GRPC_PYTHON_BUILD_WITH_CYTHON="True"
 
+ARCH=$(uname -m)
+if [[ $ARCH == "s390x" ]]; then
+    CURPWD=$(pwd)
+    cd $SRC_DIR/third_party/boringssl-with-bazel
+    git apply ${RECIPE_DIR}/0001-Fix-openssl-for-s390x.patch
+    echo "Done with patching boringssl"
+    cd $CURPWD
+fi
+
 if [[ "${target_platform}" == linux-* ]]; then
     # set these so the default in setup.py are not used
     # it seems that we need to link to pthrad on linux or osx.
@@ -20,6 +31,6 @@ if [[ "$target_platform" == osx-64 ]]; then
 fi
 
 ln -s "$(which $CC)" "$SRC_DIR/cc"
-export PATH="$SRC_DIR:$PATH"
+#export PATH="$SRC_DIR:$PATH"
 
 $PYTHON -m pip install . --no-deps --ignore-installed --no-cache-dir -vvv
diff --git a/recipe/meta.yaml b/recipe/meta.yaml
index 19fa19a..16a4566 100644
--- a/recipe/meta.yaml
+++ b/recipe/meta.yaml
@@ -1,4 +1,4 @@
-{% set version = "1.46.3" %}
+{% set version = "1.53.2" %}
 
 package:
   name: grpcio
@@ -6,12 +6,12 @@ package:
 
 source:
   url: https://pypi.io/packages/source/g/grpcio/grpcio-{{ version }}.tar.gz
-  sha256: 4b8fd8b1cd553635274b83cd984f0755e6779886eca53c1c71d48215962eb689
+  sha256: 0c9e42f2499c8603af1d88771dc97e2c6b0310c278337058fd7fd1ddb35ab853
   patches:
     - 0001-Monkey-patch-distutils.ccompiler.spawn-to-elide-std-.patch
-    - 0002-windows-ssl-lib-names.patch
-    - 0001-fix-win-setup.patch
-    - 0001-fix-win-commands.patch
+    - 0002-windows-ssl-lib-names.patch  #[win]
+    - 0001-fix-win-setup.patch          #[win]
+    - 0001-fix-win-commands.patch       #[win]
 
 build:
   number: 0
@@ -19,27 +19,27 @@ build:
 
 requirements:
   build:
-    - python                                 # [build_platform != target_platform]
+    - python {{ python }}                                 # [build_platform != target_platform]
     - cross-python_{{ target_platform }}     # [build_platform != target_platform]
     - cython                                 # [build_platform != target_platform]
     - {{ compiler('c') }}
     - {{ compiler('cxx') }}
   host:
-    - python
+    - python {{ python }}
     - pip
-    - setuptools
+    - setuptools {{ setuptools }}
     - cython
-    - six >=1.6.0
-    - zlib
-    - openssl
+    - six {{ six }}
+    - zlib {{ zlib }}
+    - openssl 3.*
     - c-ares            # [unix]
     - pthread-stubs     # [linux]
   run:
-    - python
-    - setuptools
-    - six >=1.6.0
-    - zlib
-    - openssl
+    - python {{ python }}
+    - setuptools {{ setuptools }}
+    - six {{ six }}
+    - zlib {{ zlib }}
+    - openssl 3.*
     - {{ pin_compatible("c-ares") }}  # [unix]
     - __osx >={{ MACOSX_DEPLOYMENT_TARGET|default("10.9") }}  # [osx and x86_64]
 
-- 
2.34.1

