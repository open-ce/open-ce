From be4151ce2a27d141e4626330de21059d651df9cf Mon Sep 17 00:00:00 2001
From: ArchanaShinde1 <archana.shinde2504@gmail.com>
Date: Thu, 30 Nov 2023 10:24:25 +0000
Subject: [PATCH] fix p10 build failure

---
 recipe/build.sh  |  4 ++--
 recipe/meta.yaml | 13 ++++++++-----
 2 files changed, 10 insertions(+), 7 deletions(-)

diff --git a/recipe/build.sh b/recipe/build.sh
index b337743..404e175 100644
--- a/recipe/build.sh
+++ b/recipe/build.sh
@@ -1,13 +1,13 @@
 #!/bin/bash
 
-set -euxo pipefail
+#set -euxo pipefail
 
 export UWSGI_PROFILE="${RECIPE_DIR}/uwsgi_config.ini"
 export UWSGI_INCLUDES="${PREFIX}/include,${PREFIX}/include/openssl"
 export LDFLAGS="-L${PREFIX}/lib ${LDFLAGS}"
 
 if [[ "${target_platform}" == linux-* ]]; then
-  export LDFLAGS="${LDFLAGS} -Wl,--no-as-needed"
+  export LDFLAGS="${LDFLAGS} -fno-lto -Wl,--no-as-needed"
 fi
 
 UWSGI_EMBED_PLUGINS=stats_pusher_statsd ${PYTHON} -m pip install . --no-deps -vv
diff --git a/recipe/meta.yaml b/recipe/meta.yaml
index fe977b8..9d77b2a 100644
--- a/recipe/meta.yaml
+++ b/recipe/meta.yaml
@@ -15,11 +15,13 @@ build:
   number: 3
   skip: true  # [win]
   detect_binary_files_with_prefix: true
+  ignore_run_exports:
+    - libxml2
 
 requirements:
   build:
-    - {{ compiler('c') }}
-    - {{ compiler('cxx') }}
+    - {{ compiler('c') }}                    # [ppc_arch != "p10"]
+    - {{ compiler('cxx') }}                  # [ppc_arch != "p10"]
     - python                                 # [build_platform != target_platform]
     - cross-python_{{ target_platform }}     # [build_platform != target_platform]
   host:
@@ -28,14 +30,15 @@ requirements:
     - libpython-static
     - libxml2  # [not win]
     - openssl
-    - pcre
+    - pcre 8.44
     - pip
-    - python
+    - python {{ python }}
     - yaml
-    - zlib
+    - zlib {{ zlib }}
   run:
     - jansson
     - python
+    - libxml2 >=2.9.14,<2.11.0a0
 
 test:
   source_files:
-- 
2.40.1

